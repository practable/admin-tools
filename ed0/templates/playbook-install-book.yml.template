---
- name: install book
  hosts: ${ANSIBLE_GROUP}
  become: yes
  gather_facts: no
  vars_files:
    - ../autogenerated/vars.yml
    
  tasks:
    
   - name: Install go
     community.general.snap:
       name: go
       classic: yes
       
   - name: get service facts
     service_facts:

   - name: stop book if installed
     service:
       name: book
       state: stopped
     when: ansible_facts.services["book.service"] is defined

   - git:
       repo: git@github.com:practable/book.git
       dest: /var/lib/practable/sources/book
       update: yes
       version: develop
       accept_hostkey: yes
       key_file: /etc/practable/github.key
       
   - name: book build
     command: ./build.sh
     args:
       chdir: /var/lib/practable/sources/book/scripts

   - name: book install
     command: cp book /usr/local/bin/book
     args:
       chdir: /var/lib/practable/sources/book/cmd/book 

   - name: copy book service file 
     copy: src=../autogenerated/book.service dest=/etc/systemd/system/book.service       

   - name: start book 
     service:
       name: book
       state: started
       enabled: true
       
   - name: get service facts
     service_facts:
        
   - name: check book service installed
     fail:
       msg: "book service is not installed"
     when: ansible_facts.services["book.service"] is not defined
     
  handlers:
        
    - name: reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
